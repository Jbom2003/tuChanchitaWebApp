{% extends 'layout/base.html' %}
{% load static %}
{% block title %}Mi Progreso - TuChanchita{% endblock %}

{% block extra_css %}
<style>
.progreso-container {
  max-width: 1000px;
  margin: 40px auto;
  padding: 30px;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.07);
  padding: 20px;
  border-radius: 10px;
}

.stat-card h4 {
  margin-top: 0;
  color: #60A5FA;
}

.stat-value {
  font-size: 32px;
  font-weight: bold;
  margin: 10px 0;
}

.progress-bar {
  width: 100%;
  height: 30px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 15px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #60A5FA, #3B82F6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
}

.section {
  background: rgba(255, 255, 255, 0.07);
  padding: 25px;
  border-radius: 10px;
  margin-bottom: 25px;
}

.alert-item {
  background: rgba(255, 193, 7, 0.2);
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #ffc107;
}

.alert-item.alta {
  background: rgba(244, 67, 54, 0.2);
  border-left-color: #f44336;
}

.btn-primary {
  background: #60A5FA;
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  text-decoration: none;
  display: inline-block;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-primary:hover {
  background: #3B82F6;
}

/* Fondo animado de burbujas */
.bubble-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
}

.bubble {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.07);
  animation: float infinite ease-in-out;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-60px); }
}

.progreso-container {
  position: relative;
  z-index: 1;
}
</style>
{% endblock %}

{% block content %}
<div class="bubble-container" id="bubble-container"></div>

<div class="progreso-container">
  <h2>Mi Progreso Financiero</h2>
  
  <div class="stats-grid">
    <div class="stat-card">
      <h4>Mejora en Competencias</h4>
      <div class="stat-value {% if metrics.mejora_porcentual >= 30 %}stat-positive{% else %}stat-warning{% endif %}">
        {{ metrics.mejora_porcentual|floatformat:1 }}%
      </div>
      <p>Puntaje Inicial: {{ metrics.puntaje_competencia_inicial }}</p>
      <p>Puntaje Actual: {{ metrics.puntaje_competencia_actual }}</p>
    </div>
    
    <div class="stat-card">
      <h4>Dias Activos</h4>
      <div class="stat-value">{{ metrics.dias_activos }}</div>
      <p>Sesiones Totales: {{ metrics.sesiones_totales }}</p>
    </div>
    
    <div class="stat-card">
      <h4>Retos Completados</h4>
      <div class="stat-value">{{ metrics.retos_completados }}</div>
      <p>Puntos Totales: {{ metrics.puntos_totales }}</p>
    </div>
    
    <div class="stat-card">
      <h4>Reduccion de Gasto</h4>
      <div class="stat-value" style="color: #4caf50;">
        {{ metrics.reduccion_gasto|floatformat:1 }}%
      </div>
      <p>Gasto Actual: S/. {{ gasto_actual|floatformat:2 }}</p>
      <p style="font-size: 0.9em; opacity: 0.8;">Comparado con tu primer mes de uso</p>
    </div>
    
    <div class="stat-card">
      <h4>Aumento de Ahorro</h4>
      <div class="stat-value" style="color: #4caf50;">
        {{ metrics.aumento_ahorro|floatformat:1 }}%
      </div>
      <p>Ahorro Actual: S/. {{ ahorro_actual|floatformat:2 }}</p>
      <p style="font-size: 0.9em; opacity: 0.8;">Comparado con tu primer mes de uso</p>
    </div>
    
    <div class="stat-card">
      <h4>Brecha Teorico-Practica</h4>
      {% if assessment_actual %}
        <div class="stat-value" style="color: {% if brecha_actual > 0 %}#EA580C{% elif brecha_actual < 0 %}#F59E0B{% else %}#15803D{% endif %};">
          {% if brecha_actual > 0 %}+{% endif %}{{ brecha_actual }}
        </div>
        <p style="margin-top: 10px;"><strong>Actual:</strong> {{ assessment_actual.conocimiento_teorico }} - {{ assessment_actual.aplicacion_practica }}</p>
        {% if assessment_inicial %}
          <p style="font-size: 0.9em; opacity: 0.8;"><strong>Inicial:</strong> {{ assessment_inicial.conocimiento_teorico }} - {{ assessment_inicial.aplicacion_practica }} ({{ brecha_inicial }})</p>
        {% endif %}
        <p style="font-size: 0.9em; opacity: 0.8; margin-top: 5px;">Diferencia entre conocimiento teórico y práctico</p>
      {% elif assessment_inicial %}
        <div class="stat-value" style="color: {% if brecha_inicial > 0 %}#EA580C{% elif brecha_inicial < 0 %}#F59E0B{% else %}#15803D{% endif %};">
          {% if brecha_inicial > 0 %}+{% endif %}{{ brecha_inicial }}
        </div>
        <p style="margin-top: 10px;"><strong>Inicial:</strong> {{ assessment_inicial.conocimiento_teorico }} - {{ assessment_inicial.aplicacion_practica }}</p>
        <p style="font-size: 0.9em; opacity: 0.8;">Diferencia entre conocimiento teórico y práctico</p>
      {% else %}
        <div class="stat-value">-</div>
        <p>Completa tu evaluación inicial para ver esta métrica</p>
      {% endif %}
    </div>
  </div>
  
  <div class="section">
    <h3>Alertas Recientes</h3>
    {% for alerta in alertas_recientes %}
      <div class="alert-item {% if alerta.severidad == 'alta' %}alta{% endif %}">
        <strong>{{ alerta.get_tipo_alerta_display }}</strong> - {{ alerta.descripcion }}
        <p style="margin-top: 5px; font-size: 0.9em;">{{ alerta.recomendacion }}</p>
      </div>
    {% empty %}
      <p>No hay alertas recientes. ¡Sigue asi!</p>
    {% endfor %}
    <a href="{% url 'alertas_riesgo' %}" class="btn-primary" style="display: inline-block; margin-top: 10px;">Ver todas las alertas</a>
  </div>
  
  <!-- Historial de Evaluaciones -->
  <div class="section">
    <h3 style="color: #60A5FA; margin-bottom: 20px;">Historial de Evaluaciones</h3>
    {% if evaluaciones %}
      <div style="display: grid; gap: 15px;">
        {% for evaluacion in evaluaciones %}
          <div style="background: rgba(255, 255, 255, 0.4); padding: 20px; border-radius: 8px; border-left: 4px solid #60A5FA; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <h4 style="margin: 0; color: #1E40AF; font-weight: bold;">Evaluación {{ evaluacion.numero_evaluacion }}</h4>
              <span style="color: #1F2937; font-size: 0.9em; font-weight: 500;">
                {{ evaluacion.fecha_evaluacion|date:"d/m/Y H:i" }}
              </span>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px;">
              <div>
                <strong style="color: #1F2937; font-weight: 600;">Puntaje Total:</strong>
                <div style="font-size: 1.5em; color: #1E40AF; font-weight: bold;">{{ evaluacion.puntaje_total }}</div>
              </div>
              <div>
                <strong style="color: #1F2937; font-weight: 600;">Nivel:</strong>
                <div style="text-transform: capitalize; color: #15803D; font-weight: bold;">{{ evaluacion.nivel_competencia }}</div>
              </div>
              <div style="position: relative;">
                <strong style="color: #1F2937; font-weight: 600;">
                  Brecha Teórico-Práctica:
                  <span style="font-size: 0.8em; color: #666; cursor: help; margin-left: 5px;" 
                        title="Mide la diferencia entre lo que sabes (teoría) y lo que aplicas (práctica). Ideal: 0 (equilibrio)">
                    ⓘ
                  </span>
                </strong>
                <div style="color: {% if evaluacion.calcular_brecha_teorico_practica > 0 %}#EA580C{% elif evaluacion.calcular_brecha_teorico_practica < 0 %}#F59E0B{% else %}#15803D{% endif %}; font-weight: bold; font-size: 1.2em;">
                  {% if evaluacion.calcular_brecha_teorico_practica > 0 %}
                    +{{ evaluacion.calcular_brecha_teorico_practica }} 
                    <span style="font-size: 0.7em; font-weight: normal; color: rgba(255,255,255,0.7);">
                      (sabes más de lo que aplicas)
                    </span>
                  {% elif evaluacion.calcular_brecha_teorico_practica < 0 %}
                    {{ evaluacion.calcular_brecha_teorico_practica }}
                    <span style="font-size: 0.7em; font-weight: normal; color: rgba(255,255,255,0.7);">
                      (aplicas más de lo que sabes)
                    </span>
                  {% else %}
                    0 
                    <span style="font-size: 0.7em; font-weight: normal; color: rgba(255,255,255,0.7);">
                      ✓ Equilibrio ideal
                    </span>
                  {% endif %}
                </div>
                <div style="margin-top: 8px; padding: 8px; background: rgba(0,0,0,0.1); border-radius: 5px; font-size: 0.85em; color: rgba(255,255,255,0.8);">
                  <div><strong>Teórico:</strong> {{ evaluacion.conocimiento_teorico }}/5</div>
                  <div><strong>Práctico:</strong> {{ evaluacion.aplicacion_practica }}/5</div>
                </div>
              </div>
            </div>
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(0,0,0,0.1);">
              <strong style="color: #1F2937; font-weight: 600;">Competencias:</strong>
              <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 8px;">
                <span style="background: rgba(37, 99, 235, 0.3); color: #1E40AF; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: 600;">
                  Presupuesto: {{ evaluacion.conocimiento_presupuesto }}/5
                </span>
                <span style="background: rgba(34, 197, 94, 0.3); color: #15803D; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: 600;">
                  Ahorro: {{ evaluacion.conocimiento_ahorro }}/5
                </span>
                <span style="background: rgba(251, 146, 60, 0.3); color: #EA580C; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: 600;">
                  Crédito: {{ evaluacion.conocimiento_credito }}/5
                </span>
                <span style="background: rgba(168, 85, 247, 0.3); color: #7C3AED; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: 600;">
                  Inversiones: {{ evaluacion.conocimiento_inversiones }}/5
                </span>
                <span style="background: rgba(239, 68, 68, 0.3); color: #DC2626; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; font-weight: 600;">
                  Fraudes: {{ evaluacion.conocimiento_fraudes }}/5
                </span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p style="text-align: center; color: rgba(255,255,255,0.7); padding: 30px;">
        Aún no has completado ninguna evaluación. ¡Comienza ahora para ver tu progreso!
      </p>
    {% endif %}
  </div>
  
  <div style="margin-top: 30px; text-align: center;">
    <a href="{% url 'evaluacion_view' %}" class="btn-primary" style="margin-right: 10px; background: #4caf50;">
      {% if evaluaciones %}Tomar Nueva Evaluación{% else %}Comenzar Evaluación{% endif %}
    </a>
    <a href="{% url 'recomendaciones_personalizadas' %}" class="btn-primary" style="margin-right: 10px; background: #9c27b0;">Ver Recomendaciones IA</a>
    <a href="{% url 'dashboard' %}" class="btn-primary" style="background: #666;">Volver al Dashboard</a>
  </div>
</div>

<script>
  const container = document.getElementById("bubble-container");
  for (let i = 0; i < 20; i++) {
    const bubble = document.createElement("div");
    bubble.classList.add("bubble");
    const size = Math.floor(Math.random() * 150) + 50;
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.top = `${Math.random() * 100}%`;
    bubble.style.left = `${Math.random() * 100}%`;
    bubble.style.animationDuration = `${(Math.random() * 1.5 + 3.5).toFixed(1)}s`;
    container.appendChild(bubble);
  }
</script>
{% endblock %}

