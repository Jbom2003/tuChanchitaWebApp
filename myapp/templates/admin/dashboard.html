{% extends 'layout/base.html' %}
{% load static %}
{% block title %}Panel de Administraci√≥n - TuChanchita{% endblock %}

{% block extra_css %}
<style>
.admin-container {
  max-width: 1400px;
  margin: 40px auto;
  padding: 30px;
  position: relative;
  z-index: 1;
}

.admin-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 30px;
  border-radius: 15px;
  margin-bottom: 30px;
  color: white;
  text-align: center;
}

.admin-header h1 {
  margin: 0;
  font-size: 2.5em;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.1);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.stat-card h3 {
  margin: 0 0 10px 0;
  color: #60A5FA;
}

.stat-value {
  font-size: 2.5em;
  font-weight: bold;
  color: white;
  margin: 10px 0;
}

.users-table {
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 30px;
}

.table-header {
  background: rgba(96, 165, 250, 0.3);
  padding: 15px;
  font-weight: bold;
  color: white;
}

table {
  width: 100%;
  border-collapse: collapse;
}

th, td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  color: white;
}

th {
  background: rgba(96, 165, 250, 0.2);
  font-weight: bold;
}

tr:hover {
  background: rgba(255, 255, 255, 0.05);
}

.btn-edit {
  background: #60A5FA;
  color: white;
  padding: 5px 15px;
  border-radius: 5px;
  text-decoration: none;
  font-size: 0.9em;
}

.btn-edit:hover {
  background: #3B82F6;
}

.search-box {
  margin-bottom: 20px;
  padding: 15px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 10px;
}

.search-box input {
  width: 100%;
  padding: 10px;
  border-radius: 5px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(30, 58, 138, 0.9);
  color: white;
  font-size: 16px;
}

.search-box input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

/* Fondo animado de burbujas */
.bubble-container {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
  overflow: hidden;
}

.bubble {
  position: absolute;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.07);
  animation: float infinite ease-in-out;
}

@keyframes float {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-60px); }
}
</style>
{% endblock %}

{% block content %}
<div class="bubble-container" id="bubble-container"></div>

<div class="admin-container">
  <div class="admin-header">
    <h1>üîß Panel de Administraci√≥n</h1>
    <p>Gesti√≥n de usuarios y estad√≠sticas de TuChanchita</p>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <h3>Total de Usuarios</h3>
      <div class="stat-value">{{ total_usuarios }}</div>
    </div>
    <div class="stat-card">
      <h3>Usuarios Activos</h3>
      <div class="stat-value">{{ usuarios_activos }}</div>
    </div>
    <div class="stat-card">
      <h3>Evaluaciones Totales</h3>
      <div class="stat-value">{{ total_evaluaciones }}</div>
    </div>
    <div class="stat-card">
      <h3>Gasto Promedio</h3>
      <div class="stat-value">S/. {{ gasto_promedio|floatformat:2 }}</div>
    </div>
  </div>

  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Buscar usuarios por email, nombre o apellido..." onkeyup="filtrarUsuarios()">
  </div>

  <div class="users-table">
    <div class="table-header">Usuarios Registrados</div>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Nombre</th>
          <th>Fecha Registro</th>
          <th>Puntaje Actual</th>
          <th>Mejora %</th>
          <th>D√≠as Activos</th>
          <th>Evaluaciones</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios %}
        <tr>
          <td>{{ usuario.email }}</td>
          <td>{{ usuario.first_name }} {{ usuario.last_name }}</td>
          <td>
            {% if usuario.metrics %}
              {{ usuario.metrics.fecha_registro|date:"d/m/Y" }}
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            {% if usuario.metrics %}
              {{ usuario.metrics.puntaje_competencia_actual }}
            {% else %}
              0
            {% endif %}
          </td>
          <td>
            {% if usuario.metrics %}
              <span style="color: {% if usuario.metrics.mejora_porcentual > 0 %}#4caf50{% elif usuario.metrics.mejora_porcentual < 0 %}#f44336{% else %}#999{% endif %};">
                {{ usuario.metrics.mejora_porcentual|floatformat:1 }}%
              </span>
            {% else %}
              0%
            {% endif %}
          </td>
          <td>
            {% if usuario.metrics %}
              {{ usuario.metrics.dias_activos }}
            {% else %}
              0
            {% endif %}
          </td>
          <td>
            {{ usuario.competency_assessments.count }}
          </td>
          <td>
            <a href="{% url 'admin_editar_usuario' usuario.id %}" class="btn-edit">Editar</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="8" style="text-align: center; padding: 30px; color: rgba(255,255,255,0.7);">
            No hay usuarios registrados
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const container = document.getElementById("bubble-container");
  for (let i = 0; i < 20; i++) {
    const bubble = document.createElement("div");
    bubble.classList.add("bubble");
    const size = Math.floor(Math.random() * 150) + 50;
    bubble.style.width = `${size}px`;
    bubble.style.height = `${size}px`;
    bubble.style.top = `${Math.random() * 100}%`;
    bubble.style.left = `${Math.random() * 100}%`;
    bubble.style.animationDuration = `${(Math.random() * 1.5 + 3.5).toFixed(1)}s`;
    container.appendChild(bubble);
  }

  function filtrarUsuarios() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toLowerCase();
    const table = document.getElementById('usersTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
      const td = tr[i].getElementsByTagName('td');
      let found = false;
      for (let j = 0; j < td.length - 1; j++) {
        if (td[j]) {
          const txtValue = td[j].textContent || td[j].innerText;
          if (txtValue.toLowerCase().indexOf(filter) > -1) {
            found = true;
            break;
          }
        }
      }
      tr[i].style.display = found ? '' : 'none';
    }
  }
</script>
{% endblock %}

